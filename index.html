<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Mobius Tests</title>
		<!--Underscore-->
		<script src="node_modules/underscore/underscore.js"></script>
		<!--Jquery-->
		<script src="node_modules/jqueryify/index.js"></script>
		<!--Gaunt Classes-->
		<script src="index.js"></script>
	</head>
	<body>
		<p>Mobius</p>
	<script type="text/javascript">
		var render = function(model, selector, template, renderFunc){
			if(!$.fn[renderFunc]) {
				renderFunc = "html";
			}
			template = _.template(template);
			var $el = $(selector);
			$el[renderFunc](template({model:model}));
			return $el;
		};

		var count = 0;
		var counterFunc = function() {
			return count++;
		};

		var nameFunc = function() {
			return Math.random().toString(36).substring(7);
		};

		var rendersItem = Mobius.define(function(model, options) {
			var $el = render(model, "#" + options.rendersTo + " ul", "<li id = '" + options.id + model.id + "'>" + model.name + "</li>", "append");
			this.$el = $el.find("#" + options.id + model.id);
		});

		var deletesSelf = Mobius.define(function(model, options) {
			var $el = this.$el;
			var items = this.collection.items;
			
			$el.on("click", function(){
				$el.remove();
				for(var i = 0, len = items.length; i < len; i++) {
					if(items[i] === model) {
						items.splice(i, 1);
					}
				}
			});
		});

		var Item = function(itemCollection){
			return [
			rendersItem({
				rendersTo: "todo", 
				id: "todoItem"
			}), 
			deletesSelf()];
		};
		
		var rendersItemCollection = Mobius.define(function(model, options){
			render(model, "body", "<div id = '" + options.id + "'><h1>" + options.name + "</h1><input type='text' value='Do This!'><span id = 'add'>Add+</span><ul></ul></div>");
			var items = model.items;
			for(var i = 0, len = items.length; i < len; i++) {
				Mobius(items[i], Item(model), {collection: model});
			}

			this.$el = $el =  $("#"+options.id);

			$el.find("#add").on('click', function(){
				var name = $el.find('input').val();
				var item = {id: counterFunc(), name: name};
				model.items.push(item);
				Mobius(item, Item(model), {collection: model});
			});
		});

		var ItemCollection = rendersItemCollection({
			id: "todo", 
			name: "Todos!"
		});

		Mobius({items:[
			{id: counterFunc(), name: nameFunc()},
			{id: counterFunc(), name: nameFunc()},
			{id: counterFunc(), name: nameFunc()},
			{id: counterFunc(), name: nameFunc()}
			]}, ItemCollection);
	</script>
	</body>
</html>